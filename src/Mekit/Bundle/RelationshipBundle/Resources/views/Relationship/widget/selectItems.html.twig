{% import 'OroUIBundle::macros.html.twig' as UI %}
{% import 'OroDataGridBundle::macros.html.twig' as dataGrid %}

<div class="widget-content">
	{% if saved %}
		<script type="text/javascript">
			require(['underscore', 'orotranslation/js/translator', 'oroui/js/widget-manager', 'oroui/js/messenger', 'oroui/js/mediator', 'oronavigation/js/content-manager'],
				function(_, __, widgetManager, messenger, mediator, navigationContentManager) {
					widgetManager.getWidgetInstance({{ app.request.get('_wid')|json_encode|raw }}, function(widget) {
						messenger.notificationFlashMessage('success', __('mekit.relationship.saved.message'));
						mediator.trigger('widget_success:' + widget.getWid());
						/*mediator.trigger('widget_success:' + widget.getAlias());*/

						//clear cached datagrid data
						var gridNameKey = "grid[{{ referenceableEntityConfig.get("datagrid_name_select") }}]";
						if(!_.isUndefined(mediator.execute('pageCache:state:fetch', gridNameKey))) {
							navigationContentManager.saveState(gridNameKey, null);
						}

						widget.remove();
					});
				}
			);
		</script>
	{% else %}
		{{ dataGrid.renderGrid(referenceableEntityConfig.get("datagrid_name_select"), {ref_el_id: referenceableElement.id}, {} ) }}
		<div class="form-container">
			{{ form_start(form) }}
				{{ form_widget(form.appendElements, {'id': 'appendElements'}) }}
				{{ form_widget(form.removeElements, {'id': 'removeElements'}) }}
				<div class="widget-actions form-actions" style="display: none;">
					<button class="btn" type="reset">{{ 'Cancel'|trans }}</button>
					<button class="btn btn-primary" type="submit">{{ 'Save'|trans }}</button>
				</div>
			{{ form_end(form) }}
		</div>
	{% endif %}
</div>
